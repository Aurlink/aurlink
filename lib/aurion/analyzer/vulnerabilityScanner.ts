import { SecurityAnalysis, SecurityIssue } from '../types';
import { AurionVerifier } from '../compiler/verifier';

export class VulnerabilityScanner {
  /**
   * Comprehensive security analysis
   */
  static run(code: string): SecurityAnalysis {
    const issues = AurionVerifier.verify(code);
    const passedChecks: string[] = [];
    let score = 100;

    // Calculate security score
    issues.forEach(issue => {
      switch (issue.type) {
        case 'critical': score -= 30; break;
        case 'high': score -= 20; break;
        case 'medium': score -= 10; break;
        case 'low': score -= 5; break;
        case 'info': score -= 1; break;
      }
    });

    // Positive checks
    if (code.includes('@secure')) {
      passedChecks.push('Uses @secure decorator');
      score += 10;
    }
    
    if (code.includes('onlyOwner') || code.includes('modifier')) {
      passedChecks.push('Access control patterns detected');
      score += 15;
    }
    
    if (code.includes('require(') || code.includes('assert(')) {
      passedChecks.push('Input validation present');
      score += 10;
    }

    if (code.includes('@nonReentrant')) {
      passedChecks.push('Reentrancy protection enabled');
      score += 15;
    }

    return {
      score: Math.max(0, Math.min(100, score)),
      level: this.getSecurityLevel(score),
      issues,
      recommendations: this.generateRecommendations(issues, passedChecks),
      passedChecks
    };
  }

  private static getSecurityLevel(score: number): SecurityAnalysis['level'] {
    if (score >= 90) return 'excellent';
    if (score >= 75) return 'good';
    if (score >= 60) return 'moderate';
    if (score >= 40) return 'poor';
    return 'critical';
  }

  private static generateRecommendations(issues: SecurityIssue[], passedChecks: string[]): string[] {
    const recommendations: string[] = [];
    
    if (issues.some(i => i.type === 'critical' || i.type === 'high')) {
      recommendations.push('Fix critical/high issues before deployment');
    }
    
    if (!passedChecks.some(check => check.includes('@secure'))) {
      recommendations.push('Add @secure decorator for automated security checks');
    }
    
    if (issues.some(i => i.title.includes('Access Control'))) {
      recommendations.push('Implement proper access control using modifiers');
    }

    if (issues.some(i => i.title.includes('Reentrancy'))) {
      recommendations.push('Add reentrancy guards for external calls');
    }

    return recommendations.length > 0 ? recommendations : ['Contract follows security best practices'];
  }
}